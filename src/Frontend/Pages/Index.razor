@page "/"
@using RepositoryAnalysis
@using RepositoryAnalysis.Model
@inject IDialogService DialogService
@inject AnalysisService AnalysisService
<PageTitle>Github Repository Analysis</PageTitle>

<MudPaper Height="250px" Width="100%" Class="mb-4 pb-4" Elevation="5">
    <MudContainer MaxWidth="MaxWidth.Medium">

        <MudItem Class="mt-2 pt-2">
            <MudTextField Disabled="@LockUI" InputType="InputType.Url"
                          Adornment="Adornment.End" AdornmentIcon="@Icons.Filled.Search"
                          AdornmentColor="Color.Primary"
                          OnAdornmentClick="OnSubmit"
                          InputMode="InputMode.url"
                          HelperText="Enter a github repository url and scan for any issues"
                          @bind-Value="RepositoryUrl" Label="https://github.com/owner/repo" Variant="Variant.Outlined">
            </MudTextField>
            @* <MudTextField Disabled="@LockUI" *@
            @*               InputType="InputType.Text" *@
            @*               Adornment="Adornment.End" *@
            @*               AdornmentIcon="@Icons.Filled.Sailing" *@
            @*               AdornmentColor="Color.Primary" *@
            @*               OnAdornmentClick="OnSubmitDebug" *@
            @*               InputMode="InputMode.url" *@
            @*               @bind-Value="Topic" *@
            @*               Variant="Variant.Outlined"> *@
            @* </MudTextField> *@
        </MudItem>

        <MudProgressLinear Class=@(LockUI ? "" : "invisible") Color="Color.Primary" Size="Size.Large" Indeterminate="true"/>
        <br/>

        <MudText Align="Align.Center">Try these examples: </MudText>
        <MudButton Disabled="@LockUI" Color="Color.Info" Size="Size.Small" OnClick='() => OnExampleSubmit("https://github.com/dotnet/runtime")' Variant="Variant.Text">https://github.com/dotnet/runtime</MudButton>
        <MudButton Disabled="@LockUI" Color="Color.Info" Size="Size.Small" OnClick='() => OnExampleSubmit("https://github.com/Fody/NullGuard")' Variant="Variant.Text">https://github.com/Fody/NullGuard</MudButton>
        <MudButton Disabled="@LockUI" Color="Color.Info" Size="Size.Small" OnClick='() => OnExampleSubmit("https://github.com/dotnet/roslyn")' Variant="Variant.Text">https://github.com/dotnet/roslyn</MudButton>
        <MudButton Disabled="@LockUI" Color="Color.Info" Size="Size.Small" OnClick='() => OnExampleSubmit("https://github.com/Azure/azure-sdk-for-net")' Variant="Variant.Text">https://github.com/Azure/azure-sdk-for-net</MudButton>

    </MudContainer>
</MudPaper>

<MudTabs Class="@(LockUI ? "invisible" : "visible")" Elevation="5" Rounded="true" Centered="true" Color="@Color.Surface" Style="position: relative;">

    <MudTabPanel Text="Overview">
        <MudContainer >
            @if (Analysis.OverView is not null)
            {
                <Overview Data="Analysis.OverView"></Overview>
            }
        </MudContainer>

    </MudTabPanel>
    <MudTabPanel Text="Documentation" BadgeData="@_badges.DocumentationBadge.Count" BadgeColor="@_badges.DocumentationBadge.Color">
        <AnalysisResults Items="_documentationRules"></AnalysisResults>
    </MudTabPanel>
    <MudTabPanel Text="Community" BadgeData="@_badges.CommunityBadge.Count" BadgeColor="@_badges.CommunityBadge.Color">
        <AnalysisResults Items="_communityRules"></AnalysisResults>
    </MudTabPanel>
    <MudTabPanel Text="Quality" BadgeData="@_badges.QualityBadge.Count" BadgeColor="@_badges.QualityBadge.Color">
        <AnalysisResults Items="_qualityRules"></AnalysisResults>
    </MudTabPanel>
    <MudTabPanel Text="Security" BadgeData="@_badges.SecurityBadge.Count" BadgeColor="@_badges.SecurityBadge.Color">
        <MudText Align="Align.Center" Typo="Typo.h4">coming soon</MudText>
    </MudTabPanel>
    <MudTabPanel Text=@("Language Specific - " + Analysis.OverView?.PrimaryLanguage) BadgeData="@_badges.LanguageSpecificBadge.Count" BadgeColor="@_badges.LanguageSpecificBadge.Color">
        <AnalysisResults Items="_langSpecificRules"></AnalysisResults>
    </MudTabPanel>

</MudTabs>

@code {


    public string RepositoryUrl { get; set; } = "";
    public RepoAnalysis Analysis { get; set; } = RepoAnalysis.Empty;
    private IReadOnlyList<RuleModel> _documentationRules = Array.Empty<RuleModel>();
    private IReadOnlyList<RuleModel> _qualityRules = Array.Empty<RuleModel>();
    private IReadOnlyList<RuleModel> _communityRules = Array.Empty<RuleModel>();
    private IReadOnlyList<RuleModel> _securityRules = Array.Empty<RuleModel>();
    private IReadOnlyList<RuleModel> _langSpecificRules = Array.Empty<RuleModel>();
    public bool LockUI { get; set; }
    private Badges _badges;

    [Parameter]
    [SupplyParameterFromQuery(Name = "url")]
    public string? Url { get; set; }

    private async Task ShowInvalidInputMessage()
    {
        await DialogService.ShowMessageBox(
            "Not a valid repository url",
            "Needs to be in this form: https://github.com/owner/repo");

        StateHasChanged();
    }


    protected override async Task OnParametersSetAsync()
    {
        if (Url is not null)
        {
            RepositoryUrl = Url;
        }
        await base.OnParametersSetAsync();
    }

    private async Task ShowNotFoundMessage()
    {
        await DialogService.ShowMessageBox(
            "Repository not found",
            "Please check that repository actually exist");

        StateHasChanged();
    }

    private async Task ShowErrorMessage()
    {
        await DialogService.ShowMessageBox(
            "Something went wrong",
            "Please try again later, or try with another repository.");

        StateHasChanged();
    }

    private async Task ShowIssues(
        IReadOnlyList<string> issues)
    {
        await DialogService.ShowMessageBox(
            "Potential issues found",
            string.Join(Environment.NewLine, issues));

        StateHasChanged();
    }

    private async Task OnExampleSubmit(
        string url)
    {
        RepositoryUrl = url;
        await OnSubmit();
    }

    private async Task OnSubmit()
    {
        RepositoryUrl = RepositoryUrl.Trim();
        RepositoryUrl = RepositoryUrl.TrimEnd('/');
        if (!Uri.TryCreate(RepositoryUrl, UriKind.Absolute, out var uri))
        {
            await ShowInvalidInputMessage();
            return;
        }

        if (!RepositoryUrl.StartsWith("https://github.com/"))
        {
            await ShowInvalidInputMessage();
            return;
        }

        var paths = uri.AbsolutePath.Split("/");
        if (paths.Length != 3)
        {
            await ShowInvalidInputMessage();
            return;
        }

        LockUI = true;

        var analysis = await AnalysisService.GetAnalysis(RepositoryUrl);
        switch (analysis.Status)
        {
            case RepoAnalysis.AnalysisStatus.NotFound:
                LockUI = false;
                StateHasChanged();
                await ShowNotFoundMessage();
                return;
            case RepoAnalysis.AnalysisStatus.Error:
                LockUI = false;
                StateHasChanged();
                await ShowErrorMessage();
                return;
        }

        if (analysis.Issues.Any())
        {
            LockUI = false;
            StateHasChanged();
            await ShowIssues(analysis.Issues);
        }

        Analysis = analysis;
        _documentationRules = Analysis.Documentation.Select(x => new RuleModel(x)).ToArray();
        _qualityRules = Analysis.Quality.Select(x => new RuleModel(x)).ToArray();
        _communityRules = Analysis.Community.Select(x => new RuleModel(x)).ToArray();
        _securityRules = Analysis.Security.Select(x => new RuleModel(x)).ToArray();
        _langSpecificRules = Analysis.LanguageSpecific.Select(x => new RuleModel(x)).ToArray();
        _badges = Badges.GetBadges(Analysis);
        LockUI = false;

        await Task.CompletedTask;
    }

    private async Task OnSubmitDebug()
    {
        await AnalysisService.DoBulkTest(Topic);
    }

    public string Topic { get; set; } = "";

}