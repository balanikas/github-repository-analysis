using RepositoryAnalysis.Internal.TextGeneration;
using RepositoryAnalysis.Model;

namespace RepositoryAnalysis.Internal.Rules.Security;

internal class VulnerabilityAlertsRuleApplicator : IRuleApplicator
{
    [RuleGuidance] private const string LearnMore = "How can I deep dive into the topic of github vulnerability alerts?";
    [RuleGuidance] private const string WhatIs = "What are vulnerability alerts in github?";
    [RuleGuidance] private const string Mitigate = "How can I mitigate any github vulnerability alerts?";
    [RuleGuidance] private const string IgnoringAlerts = "What happens if I ignore github vulnerability alerts for my repository?";

    private readonly IGpt3Client _gpt3Client;

    public VulnerabilityAlertsRuleApplicator(IGpt3Client gpt3Client) => _gpt3Client = gpt3Client;

    public string RuleName => "vulnerability alerts";
    public RuleCategory Category => RuleCategory.Security;
    public Language Language => Language.None;

    public async Task<Rule> ApplyAsync(AnalysisContext context)
    {
        var diagnostics = context.Repo.HasVulnerabilityAlertsEnabled
            ? context.Repo.VulnerabilityAlerts is null
                ? new RuleDiagnostics(Diagnosis.Info, "vulnerability alerts are enabled")
                : new RuleDiagnostics(Diagnosis.Info, $"vulnerability alerts are enabled, found {context.Repo.VulnerabilityAlerts.TotalCount} alerts")
            : new RuleDiagnostics(Diagnosis.Warning, "vulnerability alerts are disabled");

        return Rule.Create(this, diagnostics, new Explanation
        {
            GeneralGuidance = await _gpt3Client.GetCompletions(IgnoringAlerts, Mitigate, LearnMore),
            Text = await _gpt3Client.GetCompletion(WhatIs),
            AboutLink = new Link("about vulnerability alerts", "https://docs.github.com/en/code-security/dependabot/dependabot-alerts/about-dependabot-alerts"),
            GuidanceLink = new Link("how to configure alerts",
                "https://docs.github.com/en/code-security/dependabot/dependabot-alerts/configuring-dependabot-alerts")
        });
    }
}